name: Auto Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: ğŸ“¦ Install dependencies
      run: npm ci --only=production
    
    - name: ğŸ§ª Run tests
      run: npm test
    
    - name: ğŸ—ï¸ Build project
      run: npm run build
    
    - name: ğŸ“¦ Create release package
      run: |
        mkdir -p release-package
        cp -r src config examples tests docs package.json README.md LICENSE release-package/
        cd release-package
        tar -czf ../intelligent-project-orchestrator-${{ github.ref_name }}.tar.gz .
        cd ..
        zip -r intelligent-project-orchestrator-${{ github.ref_name }}.zip release-package/
    
    - name: ğŸ“‹ Generate changelog
      id: changelog
      run: |
        if git describe --tags --abbrev=0 HEAD^ >/dev/null 2>&1; then
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^)
          echo "Previous tag: $PREV_TAG"
          CHANGELOG=$(git log --pretty=format:"- %s (%an)" $PREV_TAG..HEAD)
        else
          echo "No previous tag found, showing all commits"
          CHANGELOG=$(git log --pretty=format:"- %s (%an)" HEAD)
        fi
        echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
        echo "$CHANGELOG" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
    
    - name: ğŸ‰ Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref_name }}
        release_name: ğŸ­ æ™ºèƒ½é¡¹ç›®ç¼–æ’ç³»ç»Ÿ ${{ github.ref_name }}
        body: |
          ## ğŸ‰ é‡å¤§æ›´æ–°
          
          ### âœ¨ æ–°åŠŸèƒ½
          - ğŸ†• **è¿è¥æ€»ç›‘è§’è‰²**: ä¸“æ³¨ç”¨æˆ·å¢é•¿å’Œæ•°æ®åˆ†æ
          - ğŸ“Š **å¢å¼ºå†³ç­–ç®—æ³•**: æå‡è§’è‰²è¯†åˆ«å‡†ç¡®ç‡è‡³95%+
          - ğŸ”„ **æ™ºèƒ½å·¥ä½œæµ**: è‡ªåŠ¨åŒ–é¡¹ç›®æµç¨‹ç¼–æ’
          - ğŸ“ˆ **æ€§èƒ½ç›‘æ§**: å®æ—¶è¿½è¸ªå›¢é˜Ÿåä½œæ•ˆç‡
          
          ### ğŸ› ï¸ æ”¹è¿›
          - âš¡ ä¼˜åŒ–è§’è‰²åˆ‡æ¢é€Ÿåº¦ï¼ˆ<500msï¼‰
          - ğŸ¯ æå‡å…³é”®è¯åŒ¹é…ç²¾åº¦
          - ğŸ“‹ å®Œå–„é¡¹ç›®æ–‡æ¡£å’ŒAPIæŒ‡å—
          - ğŸ”§ å¢å¼ºCursor IDEé›†æˆ
          - ğŸ”„ ä¼˜åŒ–CI/CDæµæ°´çº¿å’Œè‡ªåŠ¨åŒ–éƒ¨ç½²
          
          ### ğŸ“Š æ€§èƒ½æŒ‡æ ‡
          - è§’è‰²è¯†åˆ«å‡†ç¡®ç‡: >95%
          - å¹³å‡å“åº”æ—¶é—´: <500ms
          - å·¥ä½œæµæ‰§è¡Œæ•ˆç‡æå‡: 60%
          - å›¢é˜Ÿåä½œæ•ˆç‡æå‡: 40%
          
          ### ğŸš€ å¿«é€Ÿå¼€å§‹
          ```bash
          git clone https://github.com/huang-jianhua/intelligent-project-orchestrator.git
          cd intelligent-project-orchestrator
          npm install
          npm start
          ```
          
          ### ğŸ“š æ–‡æ¡£
          - [ğŸ“– å¿«é€Ÿå¼€å§‹æŒ‡å—](./README.md#quick-start)
          - [ğŸ“‹ APIæ–‡æ¡£](./docs/API.md)
          - [âš™ï¸ é…ç½®è¯´æ˜](./config/roles-config.json)
          - [ğŸŒ åœ¨çº¿æ¼”ç¤º](https://huang-jianhua.github.io/intelligent-project-orchestrator)
          
          ### ğŸ“ æ›´æ–°æ—¥å¿—
          ${{ steps.changelog.outputs.CHANGELOG }}
          
          ---
          
          ğŸ™ æ„Ÿè°¢æ‰€æœ‰è´¡çŒ®è€…çš„åŠªåŠ›ï¼å¦‚æœæ‚¨åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­é‡åˆ°ä»»ä½•é—®é¢˜ï¼Œè¯·é€šè¿‡ [Issues](https://github.com/huang-jianhua/intelligent-project-orchestrator/issues) åé¦ˆã€‚
        draft: false
        prerelease: false
    
    - name: ğŸ“¤ Upload ZIP Release Asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./intelligent-project-orchestrator-${{ github.ref_name }}.zip
        asset_name: intelligent-project-orchestrator-${{ github.ref_name }}.zip
        asset_content_type: application/zip
    
    - name: ğŸ“¤ Upload TAR.GZ Release Asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./intelligent-project-orchestrator-${{ github.ref_name }}.tar.gz
        asset_name: intelligent-project-orchestrator-${{ github.ref_name }}.tar.gz
        asset_content_type: application/gzip 