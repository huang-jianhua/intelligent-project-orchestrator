name: Auto Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  release:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ğŸ”§ Setup Git
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        echo "Git configured successfully"
    
    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: ğŸ“¦ Install dependencies
      run: |
        npm ci --only=production
        echo "Dependencies installed successfully"
    
    - name: ğŸ§ª Run tests
      run: |
        npm test
        echo "Tests completed successfully"
    
    - name: ğŸ—ï¸ Build project
      run: |
        npm run build
        echo "Build completed successfully"
    
    - name: ğŸ“¦ Create release package
      run: |
        echo "Creating release package..."
        mkdir -p release-package
        
        # å¤åˆ¶æ–‡ä»¶ï¼Œå¤„ç†å¯èƒ½ä¸å­˜åœ¨çš„æ–‡ä»¶
        [ -d "src" ] && cp -r src release-package/ || echo "src directory not found"
        [ -d "config" ] && cp -r config release-package/ || echo "config directory not found"
        [ -d "examples" ] && cp -r examples release-package/ || echo "examples directory not found"
        [ -d "tests" ] && cp -r tests release-package/ || echo "tests directory not found"
        [ -d "docs" ] && cp -r docs release-package/ || echo "docs directory not found"
        [ -f "package.json" ] && cp package.json release-package/ || echo "package.json not found"
        [ -f "README.md" ] && cp README.md release-package/ || echo "README.md not found"
        [ -f "LICENSE" ] && cp LICENSE release-package/ || echo "LICENSE not found"
        
        # åˆ›å»ºå‹ç¼©åŒ…
        cd release-package
        tar -czf ../intelligent-project-orchestrator-${{ github.ref_name }}.tar.gz .
        cd ..
        zip -r intelligent-project-orchestrator-${{ github.ref_name }}.zip release-package/
        
        echo "Release package created successfully"
        echo "Files created:"
        ls -la *.tar.gz *.zip
    
    - name: ï¿½ï¿½ Generate changelog and release notes
      run: |
        echo "Generating changelog..."
        
        # è·å–æ‰€æœ‰æ ‡ç­¾å¹¶æ’åº
        TAGS=$(git tag --sort=-version:refname)
        echo "Available tags: $TAGS"
        
        # è·å–å½“å‰æ ‡ç­¾
        CURRENT_TAG=${{ github.ref_name }}
        echo "Current tag: $CURRENT_TAG"
        
        # æŸ¥æ‰¾å‰ä¸€ä¸ªæ ‡ç­¾
        PREV_TAG=""
        FOUND_CURRENT=false
        
        for tag in $TAGS; do
          if [ "$FOUND_CURRENT" = true ]; then
            PREV_TAG="$tag"
            break
          fi
          if [ "$tag" = "$CURRENT_TAG" ]; then
            FOUND_CURRENT=true
          fi
        done
        
        # ç”Ÿæˆchangelog
        if [ -n "$PREV_TAG" ]; then
          echo "Generating changelog from $PREV_TAG to $CURRENT_TAG"
          CHANGELOG=$(git log --pretty=format:"- %s (%an)" $PREV_TAG..$CURRENT_TAG 2>/dev/null || echo "- Initial release")
        else
          echo "No previous tag found, showing recent commits"
          CHANGELOG=$(git log --pretty=format:"- %s (%an)" --max-count=10 2>/dev/null || echo "- Initial release")
        fi
        
        echo "Generated changelog:"
        echo "$CHANGELOG"
        
        # åˆ›å»ºrelease notesæ–‡ä»¶
        cat > release-notes.md << 'RELEASE_NOTES_EOF'
        ## ğŸ‰ ç‰ˆæœ¬æ›´æ–° ${{ github.ref_name }}
        
        ### âœ¨ ä¸»è¦ç‰¹æ€§
        - ğŸ­ **7ç§ä¸“ä¸šè§’è‰²**: é¡¹ç›®ç»ç†ã€è¿è¥æ€»ç›‘ã€ç³»ç»Ÿæ¶æ„å¸ˆã€äº§å“è®¾è®¡å¸ˆã€å¼€å‘å·¥ç¨‹å¸ˆã€æµ‹è¯•å·¥ç¨‹å¸ˆã€è¿ç»´å·¥ç¨‹å¸ˆ
        - ğŸ§  **æ™ºèƒ½å†³ç­–ç®—æ³•**: åŸºäºå…³é”®è¯åŒ¹é…ã€é¡¹ç›®é˜¶æ®µã€ä¸Šä¸‹æ–‡åˆ†æ
        - ğŸ”„ **è‡ªåŠ¨è§’è‰²åˆ‡æ¢**: æ ¹æ®ç”¨æˆ·è¾“å…¥æ™ºèƒ½è¯†åˆ«æœ€åˆé€‚çš„ä¸“ä¸šè§’è‰²
        - ğŸ“‹ **å·¥ä½œæµè‡ªåŠ¨ç¼–æ’**: é¢„å®šä¹‰çš„é¡¹ç›®æµç¨‹è‡ªåŠ¨æ‰§è¡Œ
        - ğŸš€ **Cursoræ·±åº¦é›†æˆ**: æ— ç¼èå…¥å¼€å‘ç¯å¢ƒ
        
        ### ğŸ› ï¸ æŠ€æœ¯æ”¹è¿›
        - âš¡ ä¼˜åŒ–è§’è‰²åˆ‡æ¢é€Ÿåº¦ï¼ˆ<500msï¼‰
        - ğŸ¯ æå‡å…³é”®è¯åŒ¹é…ç²¾åº¦è‡³95%+
        - ğŸ“‹ å®Œå–„é¡¹ç›®æ–‡æ¡£å’ŒAPIæŒ‡å—
        - ğŸ”§ å¢å¼ºCI/CDæµæ°´çº¿ç¨³å®šæ€§
        - ğŸŒ ä¼˜åŒ–GitHub Pageså±•ç¤ºé¡µé¢
        
        ### ğŸ“Š æ€§èƒ½æŒ‡æ ‡
        - **è§’è‰²è¯†åˆ«å‡†ç¡®ç‡**: >95%
        - **å¹³å‡å“åº”æ—¶é—´**: <500ms
        - **å·¥ä½œæµæ•ˆç‡æå‡**: 60%
        - **å›¢é˜Ÿåä½œæ•ˆç‡æå‡**: 40%
        
        ### ğŸš€ å¿«é€Ÿå¼€å§‹
        ```bash
        # ä¸‹è½½æºç 
        git clone https://github.com/huang-jianhua/intelligent-project-orchestrator.git
        cd intelligent-project-orchestrator
        
        # å®‰è£…ä¾èµ–
        npm install
        
        # è¿è¡Œæ¼”ç¤º
        npm start
        
        # è¿è¡Œæµ‹è¯•
        npm test
        ```
        
        ### ğŸ“š ç›¸å…³èµ„æº
        - [ğŸ“– é¡¹ç›®æ–‡æ¡£](https://github.com/huang-jianhua/intelligent-project-orchestrator/blob/main/README.md)
        - [ğŸ“‹ APIå‚è€ƒ](https://github.com/huang-jianhua/intelligent-project-orchestrator/blob/main/docs/API.md)
        - [âš™ï¸ é…ç½®æŒ‡å—](https://github.com/huang-jianhua/intelligent-project-orchestrator/blob/main/config/roles-config.json)
        - [ğŸŒ åœ¨çº¿æ¼”ç¤º](https://huang-jianhua.github.io/intelligent-project-orchestrator)
        - [ğŸ› é—®é¢˜åé¦ˆ](https://github.com/huang-jianhua/intelligent-project-orchestrator/issues)
        
        ### ğŸ“ æœ¬æ¬¡æ›´æ–°å†…å®¹
        RELEASE_NOTES_EOF
        
        echo "$CHANGELOG" >> release-notes.md
        
        cat >> release-notes.md << 'RELEASE_FOOTER_EOF'
        
        ---
        
        ğŸ’¡ **ä½¿ç”¨æç¤º**: è¿™æ˜¯ä¸€ä¸ªåŸºäºAIçš„é¡¹ç›®ç®¡ç†å·¥å…·ï¼Œå¯ä»¥æ ¹æ®ä½ çš„è¾“å…¥è‡ªåŠ¨åˆ‡æ¢åˆ°æœ€åˆé€‚çš„ä¸“ä¸šè§’è‰²ã€‚æ”¯æŒä¸­æ–‡äº¤äº’ï¼Œå®Œç¾é›†æˆCursorå¼€å‘ç¯å¢ƒã€‚
        
        ğŸ™ æ„Ÿè°¢æ‰€æœ‰è´¡çŒ®è€…ï¼å¦‚æœ‰é—®é¢˜è¯·é€šè¿‡ [Issues](https://github.com/huang-jianhua/intelligent-project-orchestrator/issues) åé¦ˆã€‚
        RELEASE_FOOTER_EOF
        
        echo "Release notes created successfully"
        cat release-notes.md
    
    - name: ğŸ‰ Create Release with GitHub CLI
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "Creating release with GitHub CLI..."
        
        # åˆ›å»ºreleaseå¹¶ä¸Šä¼ æ–‡ä»¶
        gh release create ${{ github.ref_name }} \
          --title "ğŸ­ æ™ºèƒ½é¡¹ç›®ç¼–æ’ç³»ç»Ÿ ${{ github.ref_name }}" \
          --notes-file release-notes.md \
          --latest \
          ./intelligent-project-orchestrator-${{ github.ref_name }}.zip \
          ./intelligent-project-orchestrator-${{ github.ref_name }}.tar.gz
        
        echo "Release created successfully!"
        
        # éªŒè¯release
        echo "Verifying release..."
        gh release view ${{ github.ref_name }} 